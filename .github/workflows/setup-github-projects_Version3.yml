name: Auto Create & Backfill GitHub Project (PowerShell)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened, reopened]

jobs:
  setup-project:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure gh CLI is available
        shell: pwsh
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "gh CLI not found. Attempting to install via winget..."
            try {
              winget install --id GitHub.cli -e --silent
            } catch {
              Write-Host "ERROR: winget install failed. gh CLI is required."
              exit 1
            }
          }
          Write-Host "gh CLI version: $(gh --version)"

      - name: Authenticate gh CLI
        shell: pwsh
        env:
          GH_TOKEN_SECRET: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN_SECRET: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $token = $env:GH_TOKEN_SECRET
          if ([string]::IsNullOrEmpty($token)) {
            Write-Host "GH_TOKEN not set; using GITHUB_TOKEN fallback (repo-level permissions only)."
            $token = $env:GITHUB_TOKEN_SECRET
          } else {
            Write-Host "Using GH_TOKEN secret for authentication."
          }

          if ([string]::IsNullOrEmpty($token)) {
            Write-Host "ERROR: No token available. Set secrets.GH_TOKEN or ensure GITHUB_TOKEN is available."
            exit 1
          }

          $token | gh auth login --with-token
          Write-Host "Successfully authenticated gh CLI."

      - name: Set PROJECT_NAME to repository name
        shell: pwsh
        run: |
          $full = "${{ github.repository }}"
          $repoName = $full.Split('/')[-1]
          Write-Host "Project name will be: $repoName"
          Add-Content -Path $env:GITHUB_ENV -Value "PROJECT_NAME=$repoName"

      - name: Run PowerShell setup script
        shell: pwsh
        env:
          PROJECT_DESC: "Automated project with table, board, and timeline views."
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.repository }}
        run: |
          .\.github\scripts\setup-project.ps1 -ProjectName $env:PROJECT_NAME -ProjectDesc $env:PROJECT_DESC -Owner $env:OWNER -Repo $env:REPO