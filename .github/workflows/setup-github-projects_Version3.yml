name: Import Plan to Issues

on:
  workflow_dispatch: # Manual trigger
  push:
    paths:
      - "docs/plan.md" # Auto-run when plan.md changes
      - "docs/**/*.md" # Or any markdown in docs folder

# Required permissions for GITHUB_TOKEN
permissions:
  issues: write      # Create and manage issues
  contents: read     # Read repository contents

jobs:
  import-plan:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure gh CLI is available
        shell: pwsh
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "gh CLI not found. Attempting to install via winget..."
            winget install --id GitHub.cli -e --silent
          }
          Write-Host "gh CLI version: $(gh --version)"

      - name: Authenticate gh CLI
        shell: pwsh
        env:
          GH_TOKEN_SECRET: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN_SECRET: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $token = $env:GH_TOKEN_SECRET
          if ([string]::IsNullOrEmpty($token)) {
            Write-Host "Using GITHUB_TOKEN for authentication."
            $token = $env:GITHUB_TOKEN_SECRET
          }
          $token | gh auth login --with-token
          Write-Host "Successfully authenticated gh CLI."

      - name: Run import script
        shell: pwsh
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.repository }}
        run: |
          .\.github\scripts\import-plan-to-issues.ps1 -PlanFile "docs/plan.md" -Owner $env:OWNER -Repo $env:REPO
